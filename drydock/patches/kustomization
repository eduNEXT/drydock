patches:
{% if DRYDOCK_NEWRELIC_LICENSE_KEY %}
- target:
    kind: Deployment
    name: lms
  path: plugins/drydock/k8s/newrelic.yml
{% endif -%}
- target:
    kind: Job
    labelSelector: app.kubernetes.io/component=job
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/hook: Skip
        argocd.argoproj.io/hook-delete-policy: HookFailed
    - op: add
      path: /spec
      value:
        ttlSecondsAfterFinished: 100
# Patch the sync waves
- target:
    kind: Deployment
    name:  "lms-worker|cms-worker|forum"
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "4"
{%- if DRYDOCK_DEBUG is defined and DRYDOCK_DEBUG %}
- target:
    kind: Deployment|Ingress|Service
    name:  "cms-debug|lms-debug|ingress-debug"
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "5"
{%- endif %}
{%- if POD_AUTOSCALING_LMS_HPA is defined and POD_AUTOSCALING_LMS_HPA %}
- target:
    kind: HorizontalPodAutoscaler
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "5"
{%- endif %}
{% if DRYDOCK_ENABLE_CELERY_TUNING %}
- target:
    kind: Deployment
    name:  "cms-worker"
  patch: |-
    - op: add
      path: /spec/template/spec/containers/0/args
      value:
      - celery
      - --app=cms.celery
      - worker
      - --loglevel=info
      - --concurrency=1
      - --hostname=edx.cms.core.default.%%h
      - --max-tasks-per-child=1
      - --prefetch-multiplier=1
      - --exclude-queues=edx.lms.core.default
- target:
    kind: Deployment
    name:  "lms-worker"
  patch: |-
    - op: add
      path: /spec/template/spec/containers/0/args
      value:
      - celery
      - --app=lms.celery
      - worker
      - --loglevel=info
      - --concurrency=1
      - --hostname=edx.lms.core.default.%%h
      - --max-tasks-per-child=1
      - --prefetch-multiplier=1
      - --exclude-queues=edx.cms.core.default
- target:
    kind: Deployment
    name:  "lms-worker|cms-worker"
  patch: |-
    - op: add
      path: /spec/template/spec/terminationGracePeriodSeconds
      value: 300
{% endif -%}
{% if DRYDOCK_FORUM_OVERRIDES -%}
- target:
    kind: Deployment
    name: forum
  patch: |-
    - op: add
      path: /spec/template/spec/containers/0/env/-
      value:
{% for key, value in DRYDOCK_FORUM_OVERRIDES.items() %}
        name: {{ key }}
        value: {{ value }}
{% endfor %}
{% endif -%}
{% if DRYDOCK_GRACEFUL_UWSGI -%}
- target:
    kind: Deployment
    name: lms|cms
  patch: |-
    - op: add
      path: /spec/template/spec/containers/0/lifecycle
      value:
        preStop:
          exec:
            command:
            - /bin/sh
            - -c
            - sleep 30
    - op: add
      path: /spec/template/spec/terminationGracePeriodSeconds
      value: 60
- target:
    kind: Deployment
    name: lms
  patch: |-
    - op: add
      path: /spec/template/spec/containers/0/startupProbe
      value:
        httpGet:
          httpHeaders:
          - name: Host
            value: {{ LMS_HOST }}
          path: /heartbeat
          port: 8000
        initialDelaySeconds: 5
        periodSeconds: 5
        failureThreshold: 5
        timeoutSeconds: 3
- target:
    kind: Deployment
    name: cms
  patch: |-
    - op: add
      path: /spec/template/spec/containers/0/startupProbe
      value:
        httpGet:
          httpHeaders:
          - name: Host
            value: {{ CMS_HOST }}
          path: /heartbeat
          port: 8000
        initialDelaySeconds: 5
        periodSeconds: 5
        failureThreshold: 5
        timeoutSeconds: 3
{% endif -%}
