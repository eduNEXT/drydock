{% for job in get_init_tasks() %}
apiVersion: batch/v1
kind: Job
metadata:
  name: drydock-{{ job.name }}-job
  labels:
    drydock.io/component: job
    drydock.io/target-service: {{ job.name }}
    drydock.io/runner-service: {{ job.name }}
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 100
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: {{ job.name }}
        image: {{ job.image }}
        command:
          - /bin/sh
          - -c
          - -e
        args:
        - |
          {{ job.command | indent(12) }}
        {%- if job.env %}
        env:
        {%- for env in job.env %}
          - name: {{ env.name }}
            value: {{ env.value }}
          {%- endfor %}
        {%- endif %}
        {%- if job.volumeMounts %}
        volumeMounts:
        {%- for volume in job.volumeMounts %}
          - name: {{ volume.name }}
            mountPath: {{ volume.mountPath }}
        {%- endfor %}
        {%- endif %}
      {%- if job.volumes %}
      volumes:
      {%- for volume in job.volumes %}
        - name: {{ volume.name }}
          {%- if volume.secret is defined %}
          secret:
            secretName: {{ volume.secret.secretName }}
          {%- endif %}
          {%- if volume.configMap is defined %}
          configMap:
            name: {{ volume.configMap.name }}
          {%- endif %}
        {%- endfor %}
      {%- endif %}
---
{% endfor %}
